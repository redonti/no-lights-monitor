<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Налаштування — No-Lights Monitor</title>
  <link rel="icon" href="/favicon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/css/tailwind.css" />
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    @keyframes dtek-spin { to { transform: rotate(360deg); } }
    .dtek-spinner { position:absolute; right:8px; top:calc(50% - 8px); width:16px; height:16px; border:2px solid #e7e5e4; border-top-color:#a8a29e; border-radius:50%; animation:dtek-spin 0.7s linear infinite; pointer-events:none; }
  </style>
</head>
<body class="bg-stone-100 text-stone-900 leading-relaxed">

  <header class="bg-white border-b border-stone-200 py-3.5">
    <div class="max-w-2xl mx-auto px-5 flex items-center justify-between">
      <a href="/" class="text-base font-semibold text-stone-900 no-underline">No-Lights Monitor</a>
      <span class="text-stone-400 text-sm">Налаштування</span>
    </div>
  </header>

  <!-- Loading -->
  <div id="loading" class="max-w-2xl mx-auto px-5 pt-16 text-center text-stone-400">
    Завантаження...
  </div>

  <!-- Not found -->
  <div id="not-found" class="hidden max-w-2xl mx-auto px-5 pt-16 text-center">
    <p class="text-stone-500 text-lg">Монітор не знайдено</p>
    <p class="text-stone-400 text-sm mt-2">Перевірте посилання або зверніться до бота.</p>
  </div>

  <!-- Deleted -->
  <div id="deleted" class="hidden max-w-2xl mx-auto px-5 pt-16 text-center">
    <p class="text-stone-500 text-lg">Монітор видалено</p>
    <p class="text-stone-400 text-sm mt-2">Цей монітор було видалено назавжди.</p>
  </div>

  <!-- Main content -->
  <section id="content" class="hidden pt-8 pb-14 max-sm:pt-6 max-sm:pb-9">
    <div class="max-w-2xl mx-auto px-5">

      <!-- Status bar -->
      <div class="bg-white border border-stone-200 rounded-xl p-5 mb-6">
        <div class="flex items-center justify-between mb-3">
          <h1 id="monitor-name-display" class="text-xl font-bold tracking-tight"></h1>
          <span id="status-badge" class="inline-flex items-center gap-1.5 text-sm font-medium px-2.5 py-1 rounded-full"></span>
        </div>
        <div class="text-sm text-stone-500 space-y-1">
          <p id="monitor-type-display"></p>
          <p id="monitor-address-display"></p>
          <p id="monitor-channel-display"></p>
          <p id="monitor-duration-display"></p>
        </div>
      </div>

      <!-- Edit form -->
      <div class="bg-white border border-stone-200 rounded-xl p-5 mb-6">
        <h2 class="text-lg font-semibold mb-4">Редагування</h2>

        <!-- Name -->
        <div class="mb-5">
          <label class="block text-sm font-medium text-stone-700 mb-1.5">Назва</label>
          <div class="flex gap-2">
            <input id="input-name" type="text" class="flex-1 border border-stone-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-stone-400" />
            <button onclick="saveName()" class="bg-stone-900 text-white text-sm font-medium px-4 py-2 rounded-lg hover:bg-stone-800 transition-colors">Зберегти</button>
          </div>
        </div>

        <!-- Address -->
        <div class="mb-5">
          <label class="block text-sm font-medium text-stone-700 mb-1.5">Адреса</label>
          <div class="flex gap-2">
            <input id="input-address" type="text" class="flex-1 border border-stone-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-stone-400" placeholder="Київ, вул. Хрещатик 1" />
            <button onclick="saveAddress()" class="bg-stone-900 text-white text-sm font-medium px-4 py-2 rounded-lg hover:bg-stone-800 transition-colors">Зберегти</button>
          </div>
          <p class="text-xs text-stone-400 mt-1">Адресу буде геокодовано автоматично.</p>
        </div>

        <!-- Toggles -->
        <div class="space-y-3 mb-5">
          <label class="flex items-center justify-between cursor-pointer">
            <span class="text-sm text-stone-700">Показувати на публічній карті</span>
            <input id="toggle-public" type="checkbox" onchange="saveToggle('is_public', this.checked)" class="w-9 h-5 rounded-full appearance-none bg-stone-300 checked:bg-stone-900 relative cursor-pointer transition-colors after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:w-4 after:h-4 after:rounded-full after:bg-white after:transition-transform checked:after:translate-x-4" />
          </label>
          <label class="flex items-center justify-between cursor-pointer">
            <span class="text-sm text-stone-700">Показувати адресу в сповіщеннях</span>
            <input id="toggle-notify-address" type="checkbox" onchange="saveToggle('notify_address', this.checked)" class="w-9 h-5 rounded-full appearance-none bg-stone-300 checked:bg-stone-900 relative cursor-pointer transition-colors after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:w-4 after:h-4 after:rounded-full after:bg-white after:transition-transform checked:after:translate-x-4" />
          </label>
          <label class="flex items-center justify-between cursor-pointer">
            <span class="text-sm text-stone-700">Публікувати графік аптайму в каналі</span>
            <input id="toggle-graph" type="checkbox" onchange="saveToggle('graph_enabled', this.checked)" class="w-9 h-5 rounded-full appearance-none bg-stone-300 checked:bg-stone-900 relative cursor-pointer transition-colors after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:w-4 after:h-4 after:rounded-full after:bg-white after:transition-transform checked:after:translate-x-4" />
          </label>
        </div>

        <!-- Outage group -->
        <div class="mb-2">
          <label class="block text-sm font-medium text-stone-700 mb-1.5">Група відключень</label>
          <div class="flex flex-col sm:flex-row gap-2">
            <select id="select-region" onchange="loadGroups()" class="border border-stone-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-stone-400">
              <option value="">Оберіть регіон</option>
            </select>
            <select id="select-group" class="flex-1 border border-stone-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-stone-400">
              <option value="">Оберіть групу</option>
            </select>
            <button onclick="saveOutageGroup()" class="bg-stone-900 text-white text-sm font-medium px-4 py-2 rounded-lg hover:bg-stone-800 transition-colors">Зберегти</button>
          </div>
          <p id="outage-current" class="text-xs text-stone-400 mt-1"></p>

          <!-- Outage-dependent toggles (only active when group is set) -->
          <div id="outage-toggles" class="space-y-3 mt-4">
            <label class="flex items-center justify-between cursor-pointer">
              <span id="label-notify-outage" class="text-sm text-stone-700">Показувати графік відключень в сповіщеннях</span>
              <input id="toggle-notify-outage" type="checkbox" onchange="saveToggle('notify_outage', this.checked)" disabled class="w-9 h-5 rounded-full appearance-none bg-stone-300 checked:bg-stone-900 relative cursor-pointer transition-colors after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:w-4 after:h-4 after:rounded-full after:bg-white after:transition-transform checked:after:translate-x-4 disabled:opacity-40 disabled:cursor-not-allowed" />
            </label>
            <label class="flex items-center justify-between cursor-pointer">
              <span id="label-outage-photo" class="text-sm text-stone-700">Публікувати фото графіка відключень в каналі</span>
              <input id="toggle-outage-photo" type="checkbox" onchange="saveToggle('outage_photo_enabled', this.checked)" disabled class="w-9 h-5 rounded-full appearance-none bg-stone-300 checked:bg-stone-900 relative cursor-pointer transition-colors after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:w-4 after:h-4 after:rounded-full after:bg-white after:transition-transform checked:after:translate-x-4 disabled:opacity-40 disabled:cursor-not-allowed" />
            </label>
          </div>
        </div>
      </div>

      <!-- DTEK Unplanned Outage Monitor -->
      <div class="bg-white border border-stone-200 rounded-xl p-5 mb-6">
        <div class="flex items-start justify-between mb-1">
          <div>
            <div class="flex items-center gap-2">
              <h2 class="text-lg font-semibold">Аварійний моніторинг ДТЕК</h2>
              <span class="text-xs font-medium bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded-md">бета</span>
            </div>
            <p class="text-xs text-stone-400 mt-0.5">Якщо світла немає — перевіряє адресу в ДТЕК і сповіщає про аварійне відключення</p>
          </div>
          <input id="toggle-dtek" type="checkbox" onchange="saveDtekEnabled(this.checked)" class="mt-1 w-9 h-5 rounded-full appearance-none bg-stone-300 checked:bg-stone-900 relative cursor-pointer transition-colors after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:w-4 after:h-4 after:rounded-full after:bg-white after:transition-transform checked:after:translate-x-4" />
        </div>
        <p id="dtek-current" class="text-xs text-stone-400 mb-4"></p>

        <div class="space-y-3">
          <!-- Region -->
          <div>
            <label class="block text-xs font-medium text-stone-600 mb-1">Регіон ДТЕК</label>
            <select id="dtek-region" onchange="onDtekRegionChange()" class="w-full border border-stone-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-stone-400">
              <option value="">Оберіть регіон</option>
              <option value="k">Київ (DTEK KEM)</option>
              <option value="kr">Київська область (DTEK KREM)</option>
              <option value="dn">Дніпро (DTEK DNEM)</option>
              <option value="o">Одеса (DTEK OEM)</option>
              <option value="d">Донецький регіон (DTEK DEM)</option>
            </select>
          </div>

          <!-- City (hidden for region k — Kyiv) -->
          <div id="dtek-city-group">
            <label class="block text-xs font-medium text-stone-600 mb-1">Місто</label>
            <div class="relative">
              <input id="dtek-city-input" type="text" oninput="onDtekCityInput()" autocomplete="off" disabled
                class="w-full border border-stone-300 rounded-lg px-3 pr-8 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-stone-400 disabled:opacity-40 disabled:cursor-not-allowed"
                placeholder="Введіть місто..." />
              <span id="dtek-city-spinner" class="hidden dtek-spinner"></span>
              <div id="dtek-city-dropdown" class="hidden absolute z-20 left-0 right-0 top-full mt-1 bg-white border border-stone-200 rounded-lg shadow-lg max-h-48 overflow-y-auto"></div>
            </div>
          </div>

          <!-- Street -->
          <div>
            <label class="block text-xs font-medium text-stone-600 mb-1">Вулиця</label>
            <div class="relative">
              <input id="dtek-street-input" type="text" oninput="onDtekStreetInput()" autocomplete="off" disabled
                class="w-full border border-stone-300 rounded-lg px-3 pr-8 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-stone-400 disabled:opacity-40 disabled:cursor-not-allowed"
                placeholder="Введіть вулицю..." />
              <span id="dtek-street-spinner" class="hidden dtek-spinner"></span>
              <div id="dtek-street-dropdown" class="hidden absolute z-20 left-0 right-0 top-full mt-1 bg-white border border-stone-200 rounded-lg shadow-lg max-h-48 overflow-y-auto"></div>
            </div>
          </div>

          <!-- House -->
          <div>
            <label class="block text-xs font-medium text-stone-600 mb-1">Будинок</label>
            <div class="relative">
              <input id="dtek-house-input" type="text" oninput="setDtekSpinner('house', true); dtekDebounce(fetchDtekHouseSuggestions)" autocomplete="off" disabled
                class="w-full border border-stone-300 rounded-lg px-3 pr-8 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-stone-400 disabled:opacity-40 disabled:cursor-not-allowed"
                placeholder="Номер будинку" />
              <span id="dtek-house-spinner" class="hidden dtek-spinner"></span>
              <div id="dtek-house-dropdown" class="hidden absolute z-20 left-0 right-0 top-full mt-1 bg-white border border-stone-200 rounded-lg shadow-lg max-h-48 overflow-y-auto"></div>
            </div>
          </div>

          <button onclick="saveDtekAddress()" class="bg-stone-900 text-white text-sm font-medium px-4 py-2 rounded-lg hover:bg-stone-800 transition-colors">Зберегти адресу</button>
        </div>
      </div>

      <!-- Actions -->
      <div class="bg-white border border-stone-200 rounded-xl p-5">
        <h2 class="text-lg font-semibold mb-4">Дії</h2>
        <div class="flex flex-wrap gap-3">
          <button id="btn-stop" onclick="stopMonitor()" class="bg-amber-500 text-white text-sm font-medium px-5 py-2.5 rounded-lg hover:bg-amber-600 transition-colors">
            Призупинити моніторинг
          </button>
          <button id="btn-resume" onclick="resumeMonitor()" class="hidden bg-green-600 text-white text-sm font-medium px-5 py-2.5 rounded-lg hover:bg-green-700 transition-colors">
            Відновити моніторинг
          </button>
          <button id="btn-delete" onclick="confirmDelete()" class="bg-red-600 text-white text-sm font-medium px-5 py-2.5 rounded-lg hover:bg-red-700 transition-colors">
            Видалити монітор
          </button>
        </div>
      </div>

      <!-- Toast -->
      <div id="toast" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-stone-900 text-white text-sm px-5 py-2.5 rounded-xl shadow-lg z-50 transition-opacity"></div>

      <!-- Delete confirm modal -->
      <div id="delete-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50 p-5">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full shadow-xl">
          <h3 class="text-lg font-semibold mb-2">Видалити монітор?</h3>
          <p class="text-sm text-stone-500 mb-5">Ця дія незворотна. Всі дані про історію статусу будуть втрачені.</p>
          <div class="flex gap-3 justify-end">
            <button onclick="closeDeleteModal()" class="text-sm font-medium px-4 py-2 rounded-lg border border-stone-300 hover:bg-stone-50 transition-colors">Скасувати</button>
            <button onclick="deleteMonitor()" class="bg-red-600 text-white text-sm font-medium px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">Видалити</button>
          </div>
        </div>
      </div>

    </div>
  </section>

  <script>
    const token = window.location.pathname.split('/').pop();
    const API = '/api/settings/' + token;
    let monitor = null;

    // ── DTEK autocomplete state ───────────────────────────────────────
    let dtekCityValue = '';   // exact city selected from suggestion
    let dtekStreetValue = ''; // exact street selected from suggestion
    let dtekDebounceTimer = null;

    function dtekDebounce(fn) {
      clearTimeout(dtekDebounceTimer);
      dtekDebounceTimer = setTimeout(fn, 400);
    }

    function onDtekCityInput() {
      const q = document.getElementById('dtek-city-input').value;
      if (q.length >= 3) { setDtekSpinner('city', true); }
      else { setDtekSpinner('city', false); document.getElementById('dtek-city-dropdown').classList.add('hidden'); }
      dtekDebounce(fetchDtekCitySuggestions);
    }

    function onDtekStreetInput() {
      const q = document.getElementById('dtek-street-input').value;
      if (q.length >= 3) { setDtekSpinner('street', true); }
      else { setDtekSpinner('street', false); document.getElementById('dtek-street-dropdown').classList.add('hidden'); }
      dtekDebounce(fetchDtekStreetSuggestions);
    }

    function onDtekRegionChange() {
      const isKyiv = document.getElementById('dtek-region').value === 'k';
      document.getElementById('dtek-city-group').classList.toggle('hidden', isKyiv);
      dtekCityValue = '';
      dtekStreetValue = '';
      document.getElementById('dtek-city-input').value = '';
      document.getElementById('dtek-street-input').value = '';
      document.getElementById('dtek-house-input').value = '';
      hideDtekDropdowns();
      updateDtekFieldStates();
    }

    function hideDtekDropdowns() {
      ['dtek-city-dropdown', 'dtek-street-dropdown', 'dtek-house-dropdown'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
      });
    }

    function setDtekSpinner(field, show) {
      document.getElementById('dtek-' + field + '-spinner').classList.toggle('hidden', !show);
    }

    function updateDtekFieldStates() {
      const region = document.getElementById('dtek-region').value;
      const isKyiv = region === 'k';
      document.getElementById('dtek-city-input').disabled = !region;
      document.getElementById('dtek-street-input').disabled = !region || (!isKyiv && !dtekCityValue);
      document.getElementById('dtek-house-input').disabled = !dtekStreetValue;
    }

    function showDtekDropdown(dropdownId, suggestions, onSelect) {
      const el = document.getElementById(dropdownId);
      el.innerHTML = '';
      if (!suggestions || suggestions.length === 0) { el.classList.add('hidden'); return; }
      suggestions.forEach(s => {
        const item = document.createElement('div');
        item.className = 'px-3 py-2 text-sm cursor-pointer hover:bg-stone-100';
        item.textContent = s;
        item.onmousedown = (e) => { e.preventDefault(); onSelect(s); };
        el.appendChild(item);
      });
      el.classList.remove('hidden');
    }

    async function fetchDtekSuggestions(params) {
      try {
        const qs = new URLSearchParams(params).toString();
        const res = await fetch('/api/dtek/suggest?' + qs);
        if (!res.ok) return [];
        const data = await res.json();
        return data.suggestions || [];
      } catch (e) { return []; }
    }

    async function fetchDtekCitySuggestions() {
      const region = document.getElementById('dtek-region').value;
      const q = document.getElementById('dtek-city-input').value;
      if (!region || q.length < 3) { setDtekSpinner('city', false); return; }
      const suggestions = await fetchDtekSuggestions({ region, q });
      setDtekSpinner('city', false);
      showDtekDropdown('dtek-city-dropdown', suggestions, (s) => {
        document.getElementById('dtek-city-input').value = s;
        dtekCityValue = s;
        dtekStreetValue = '';
        document.getElementById('dtek-street-input').value = '';
        document.getElementById('dtek-house-input').value = '';
        document.getElementById('dtek-city-dropdown').classList.add('hidden');
        updateDtekFieldStates();
      });
    }

    async function fetchDtekStreetSuggestions() {
      const region = document.getElementById('dtek-region').value;
      const q = document.getElementById('dtek-street-input').value;
      if (!region || q.length < 3) { setDtekSpinner('street', false); return; }
      const params = { region, q };
      if (region !== 'k' && dtekCityValue) params.city = dtekCityValue;
      const suggestions = await fetchDtekSuggestions(params);
      setDtekSpinner('street', false);
      showDtekDropdown('dtek-street-dropdown', suggestions, (s) => {
        document.getElementById('dtek-street-input').value = s;
        dtekStreetValue = s;
        document.getElementById('dtek-house-input').value = '';
        document.getElementById('dtek-street-dropdown').classList.add('hidden');
        updateDtekFieldStates();
      });
    }

    async function fetchDtekHouseSuggestions() {
      const region = document.getElementById('dtek-region').value;
      const street = dtekStreetValue || document.getElementById('dtek-street-input').value;
      const q = document.getElementById('dtek-house-input').value;
      if (!region || !street || q.length < 1) { setDtekSpinner('house', false); return; }
      const params = { region, street, q };
      if (region !== 'k' && dtekCityValue) params.city = dtekCityValue;
      const suggestions = await fetchDtekSuggestions(params);
      setDtekSpinner('house', false);
      showDtekDropdown('dtek-house-dropdown', suggestions, (s) => {
        document.getElementById('dtek-house-input').value = s;
        document.getElementById('dtek-house-dropdown').classList.add('hidden');
      });
    }

    async function saveDtekEnabled(value) {
      try {
        const res = await fetch(API, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dtek_enabled: value })
        });
        if (res.ok) { showToast('Збережено'); }
        else { showToast('Помилка збереження'); reload(); }
      } catch (e) { showToast('Помилка збереження'); reload(); }
    }

    async function saveDtekAddress() {
      const region = document.getElementById('dtek-region').value;
      const city = document.getElementById('dtek-city-input').value.trim();
      const street = document.getElementById('dtek-street-input').value.trim();
      const house = document.getElementById('dtek-house-input').value.trim();
      if (!region) { showToast('Оберіть регіон'); return; }
      if (region !== 'k' && !city) { showToast('Введіть місто'); return; }
      if (!street) { showToast('Введіть вулицю'); return; }
      if (!house) { showToast('Введіть номер будинку'); return; }
      try {
        const res = await fetch(API, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dtek_region: region, dtek_city: city, dtek_street: street, dtek_house: house })
        });
        if (res.ok) { showToast('Адресу ДТЕК збережено'); reload(); }
        else { showToast('Помилка збереження'); }
      } catch (e) { showToast('Помилка збереження'); }
    }

    // Close dropdowns on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#dtek-city-group, #dtek-street-input, #dtek-house-input, #dtek-street-dropdown, #dtek-house-dropdown')) {
        hideDtekDropdowns();
      }
    });

    function showToast(msg, duration = 2500) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.remove('hidden');
      el.style.opacity = '1';
      setTimeout(() => {
        el.style.opacity = '0';
        setTimeout(() => el.classList.add('hidden'), 300);
      }, duration);
    }

    function render(m) {
      monitor = m;

      // Header info
      document.getElementById('monitor-name-display').textContent = m.name;
      const badge = document.getElementById('status-badge');
      if (!m.is_active) {
        badge.innerHTML = '<span class="w-2 h-2 rounded-full bg-stone-400"></span> Призупинено';
        badge.className = 'inline-flex items-center gap-1.5 text-sm font-medium px-2.5 py-1 rounded-full bg-stone-100 text-stone-500';
      } else if (m.is_online) {
        badge.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Онлайн';
        badge.className = 'inline-flex items-center gap-1.5 text-sm font-medium px-2.5 py-1 rounded-full bg-green-50 text-green-700';
      } else {
        badge.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> Офлайн';
        badge.className = 'inline-flex items-center gap-1.5 text-sm font-medium px-2.5 py-1 rounded-full bg-red-50 text-red-700';
      }

      const typeLabel = m.monitor_type === 'ping' ? 'Server Ping' : 'ESP Heartbeat';
      document.getElementById('monitor-type-display').textContent = 'Тип: ' + typeLabel + (m.ping_target ? ' (' + m.ping_target + ')' : '');
      document.getElementById('monitor-address-display').textContent = 'Адреса: ' + m.address;
      document.getElementById('monitor-channel-display').textContent = m.channel_name ? 'Канал: @' + m.channel_name : '';
      document.getElementById('monitor-duration-display').textContent = 'У поточному статусі: ' + m.status_duration;

      // Form values
      document.getElementById('input-name').value = m.name;
      document.getElementById('input-address').value = m.address;
      document.getElementById('toggle-public').checked = m.is_public;
      document.getElementById('toggle-notify-address').checked = m.notify_address;
      document.getElementById('toggle-graph').checked = m.graph_enabled;

      // Outage-dependent toggles
      const hasGroup = !!m.outage_group;
      document.getElementById('toggle-notify-outage').checked = m.notify_outage;
      document.getElementById('toggle-notify-outage').disabled = !hasGroup;
      document.getElementById('label-notify-outage').classList.toggle('opacity-40', !hasGroup);
      document.getElementById('toggle-outage-photo').checked = m.outage_photo_enabled;
      document.getElementById('toggle-outage-photo').disabled = !hasGroup;
      document.getElementById('label-outage-photo').classList.toggle('opacity-40', !hasGroup);

      // Outage display
      if (m.outage_group) {
        document.getElementById('outage-current').textContent = 'Поточна група: ' + m.outage_group + ' (' + m.outage_region + ')';
      } else {
        document.getElementById('outage-current').textContent = 'Група не встановлена';
      }

      // DTEK
      document.getElementById('toggle-dtek').checked = m.dtek_enabled;
      document.getElementById('dtek-region').value = m.dtek_region || '';
      document.getElementById('dtek-city-input').value = m.dtek_city || '';
      document.getElementById('dtek-street-input').value = m.dtek_street || '';
      document.getElementById('dtek-house-input').value = m.dtek_house || '';
      dtekCityValue = m.dtek_city || '';
      dtekStreetValue = m.dtek_street || '';
      document.getElementById('dtek-city-group').classList.toggle('hidden', m.dtek_region === 'k');
      updateDtekFieldStates();
      if (m.dtek_region && m.dtek_street && m.dtek_house) {
        const parts = [m.dtek_city, m.dtek_street, m.dtek_house].filter(Boolean);
        document.getElementById('dtek-current').textContent = 'Адреса: ' + parts.join(', ');
      } else {
        document.getElementById('dtek-current').textContent = 'Адресу не налаштовано';
      }

      // Stop/Resume buttons
      if (m.is_active) {
        document.getElementById('btn-stop').classList.remove('hidden');
        document.getElementById('btn-resume').classList.add('hidden');
      } else {
        document.getElementById('btn-stop').classList.add('hidden');
        document.getElementById('btn-resume').classList.remove('hidden');
      }

      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');
    }

    async function load() {
      try {
        const res = await fetch(API);
        if (res.status === 404) {
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('not-found').classList.remove('hidden');
          return;
        }
        const data = await res.json();
        render(data);
        loadRegions();
      } catch (e) {
        document.getElementById('loading').textContent = 'Помилка завантаження.';
      }
    }

    async function saveName() {
      const name = document.getElementById('input-name').value.trim();
      if (name.length < 2) { showToast('Назва занадто коротка'); return; }
      try {
        const res = await fetch(API, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        if (res.ok) {
          showToast('Назву оновлено');
          reload();
        } else {
          showToast('Помилка збереження');
        }
      } catch (e) { showToast('Помилка збереження'); }
    }

    async function saveAddress() {
      const address = document.getElementById('input-address').value.trim();
      if (address.length < 3) { showToast('Адреса занадто коротка'); return; }
      showToast('Шукаю адресу...', 5000);
      try {
        const res = await fetch(API, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ address })
        });
        if (res.ok) {
          showToast('Адресу оновлено');
          reload();
        } else {
          showToast('Помилка збереження');
        }
      } catch (e) { showToast('Помилка збереження'); }
    }

    async function saveToggle(field, value) {
      try {
        const res = await fetch(API, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [field]: value })
        });
        if (res.ok) {
          showToast('Збережено');
        } else {
          showToast('Помилка збереження');
        }
      } catch (e) { showToast('Помилка збереження'); }
    }

    async function loadRegions() {
      try {
        const res = await fetch('/api/outage/regions');
        if (!res.ok) return;
        const regions = await res.json();
        const sel = document.getElementById('select-region');
        sel.innerHTML = '<option value="">Оберіть регіон</option>';
        regions.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r.region_id;
          opt.textContent = r.region_id;
          if (monitor && r.region_id === monitor.outage_region) opt.selected = true;
          sel.appendChild(opt);
        });
        if (monitor && monitor.outage_region) loadGroups();
      } catch (e) {}
    }

    async function loadGroups() {
      const region = document.getElementById('select-region').value;
      const sel = document.getElementById('select-group');
      sel.innerHTML = '<option value="">Оберіть групу</option>';
      if (!region) return;
      try {
        const res = await fetch('/api/outage/' + region + '/groups');
        if (!res.ok) return;
        const data = await res.json();
        data.groups.forEach(g => {
          const opt = document.createElement('option');
          opt.value = g.id;
          opt.textContent = g.name;
          if (monitor && g.id === monitor.outage_group) opt.selected = true;
          sel.appendChild(opt);
        });
      } catch (e) {}
    }

    async function saveOutageGroup() {
      const region = document.getElementById('select-region').value;
      const group = document.getElementById('select-group').value;
      if (!region || !group) { showToast('Оберіть регіон та групу'); return; }
      try {
        const res = await fetch(API, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ outage_region: region, outage_group: group })
        });
        if (res.ok) {
          showToast('Групу відключень оновлено');
          reload();
        } else {
          showToast('Помилка збереження');
        }
      } catch (e) { showToast('Помилка збереження'); }
    }

    async function stopMonitor() {
      try {
        const res = await fetch(API + '/stop', { method: 'POST' });
        if (res.ok) {
          showToast('Моніторинг призупинено');
          reload();
        } else {
          showToast('Помилка');
        }
      } catch (e) { showToast('Помилка'); }
    }

    async function resumeMonitor() {
      try {
        const res = await fetch(API + '/resume', { method: 'POST' });
        if (res.ok) {
          showToast('Моніторинг відновлено');
          reload();
        } else {
          showToast('Помилка');
        }
      } catch (e) { showToast('Помилка'); }
    }

    function confirmDelete() {
      document.getElementById('delete-modal').classList.remove('hidden');
    }

    function closeDeleteModal() {
      document.getElementById('delete-modal').classList.add('hidden');
    }

    async function deleteMonitor() {
      closeDeleteModal();
      try {
        const res = await fetch(API, { method: 'DELETE' });
        if (res.ok) {
          document.getElementById('content').classList.add('hidden');
          document.getElementById('deleted').classList.remove('hidden');
        } else {
          showToast('Помилка видалення');
        }
      } catch (e) { showToast('Помилка видалення'); }
    }

    async function reload() {
      try {
        const res = await fetch(API);
        if (res.ok) render(await res.json());
      } catch (e) {}
    }

    load();
  </script>

</body>
</html>
